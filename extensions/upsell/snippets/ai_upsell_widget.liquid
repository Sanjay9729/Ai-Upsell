{% comment %}
  AI-Powered Upsell Products Block
  Shows intelligent product recommendations on product pages
  Also shows secondary recommendations based on last added upsell product (on cart page)
{% endcomment %}

{% assign upsell_settings = settings %}
{% if block and block.settings %}
  {% assign upsell_settings = block.settings %}
{% endif %}

{% unless request.page_type == 'cart' %}
<div class="ai-upsell-widget" data-product-id="{{ product.id }}" data-shop="{{ shop.permanent_domain }}" data-source="{{ source | default: 'block' }}">
  <div class="ai-upsell-loading">
    <div class="ai-upsell-spinner"></div>
    <p>{{ upsell_settings.loading_text }}</p>
  </div>
  <div class="ai-upsell-content" style="display: none;"></div>
</div>
{% endunless %}

<!-- Secondary Recommendations Widget (hidden until triggered) -->
<div class="ai-secondary-widget" data-shop="{{ shop.permanent_domain }}" data-source="{{ source | default: 'block' }}" style="display: none;">
  <div class="ai-secondary-loading" style="display: none;">
    <div class="ai-secondary-spinner"></div>
    <p>{{ upsell_settings.loading_text }}</p>
  </div>
  <div class="ai-secondary-content"></div>
</div>

<script>
  // Set up fetch interceptor IMMEDIATELY (before anything else)
  (function() {
    if (window.__AI_UPSELL_FETCH_HOOK__) return;
    window.__AI_UPSELL_FETCH_HOOK__ = true;
    console.log('üöÄ AI Upsell Products script loading...');
    console.log('üìç Current page:', window.location.pathname);
    console.log('üîç Looking for .ai-secondary-widget:', !!document.querySelector('.ai-secondary-widget'));
    
    const _originalFetch = window.fetch;
    window.fetch = function(url, options) {
      const result = _originalFetch.apply(this, arguments);

      if (typeof url === 'string' && url.includes('/cart/add.js') && options && options.method === 'POST') {
        console.log('üéØ Intercepted /cart/add.js call');
        result.then(response => {
          if (response.ok) {
            response.clone().json().then(data => {
              const addedProductId = data.product_id;
              if (addedProductId) {
                console.log('üîÑ Secondary: intercepted cart add for product:', addedProductId);
                try {
                  sessionStorage.setItem('lastAiUpsellProduct', addedProductId.toString());
                  console.log('‚úÖ Stored in sessionStorage:', addedProductId);
                } catch (err) {
                  console.error('‚ùå SessionStorage error:', err);
                }
                const isCart = window.location.pathname === '/cart' || window.location.pathname.startsWith('/cart');
                console.log('üìç Is cart page?', isCart);
                if (isCart) {
                  console.log('üîÑ On cart page, will load secondary recommendations...');
                  if (window.__AI_UPSELL_SKIP_NEXT_CART_ADD__) {
                    window.__AI_UPSELL_SKIP_NEXT_CART_ADD__ = false;
                    return;
                  }
                  setTimeout(() => {
                    if (typeof window.__AI_UPSELL_REFRESH_SECONDARY__ === 'function') {
                      window.__AI_UPSELL_REFRESH_SECONDARY__();
                    }
                  }, 500);
                }
              }
            }).catch(() => {});
          }
        }).catch(() => {});
      }

      return result;
    };
    console.log('‚úÖ Fetch interceptor installed');
  })();
</script>

<script>
  (function() {
    let widget = null;
    let secondaryWidget = null;

    function pickWidgets() {
      const widgets = Array.from(document.querySelectorAll('.ai-upsell-widget'));
      const secondaryWidgets = Array.from(document.querySelectorAll('.ai-secondary-widget'));
      const embedWidget = widgets.find(w => w.dataset.source === 'embed');
      const embedSecondary = secondaryWidgets.find(w => w.dataset.source === 'embed');

      if (embedWidget) {
        widgets.forEach(w => { if (w !== embedWidget) w.remove(); });
        widget = embedWidget;
      } else {
        widget = widgets[0] || null;
      }

      if (embedSecondary) {
        secondaryWidgets.forEach(w => { if (w !== embedSecondary) w.remove(); });
        secondaryWidget = embedSecondary;
      } else {
        secondaryWidget = secondaryWidgets[0] || null;
      }

      if (widget) window.__AI_UPSELL_WIDGET__ = widget;
      if (secondaryWidget) window.__AI_UPSELL_SECONDARY__ = secondaryWidget;

      if (!widget && window.__AI_UPSELL_WIDGET__) widget = window.__AI_UPSELL_WIDGET__;
      if (!secondaryWidget && window.__AI_UPSELL_SECONDARY__) secondaryWidget = window.__AI_UPSELL_SECONDARY__;
    }

    function insertAfter(target, node) {
      if (!target || !target.parentNode || !node) return;
      if (target.nextSibling) {
        target.parentNode.insertBefore(node, target.nextSibling);
      } else {
        target.parentNode.appendChild(node);
      }
    }

    function getWidgetWrapper(node) {
      if (!node) return null;
      const existing = node.closest('.ai-upsell-wrapper');
      if (existing) return existing;
      const wrapper = document.createElement('div');
      wrapper.className = 'ai-upsell-wrapper';
      if (document.querySelector('.page-width')) {
        wrapper.classList.add('page-width');
      }
      wrapper.appendChild(node);
      return wrapper;
    }

    function startLoadingFallback(targetWidget, loadingEl, timeoutMs) {
      if (!targetWidget) return;
      if (targetWidget.__aiUpsellLoadingTimer) {
        clearTimeout(targetWidget.__aiUpsellLoadingTimer);
      }
      if (loadingEl) loadingEl.style.display = 'block';
      targetWidget.__aiUpsellLoadingTimer = setTimeout(() => {
        const contentEl = targetWidget.querySelector('.ai-upsell-content, .ai-secondary-content');
        const hasContent = contentEl && contentEl.innerHTML.trim() !== '';
        if (!hasContent) {
          targetWidget.style.display = 'none';
        }
      }, timeoutMs || 6000);
    }

    function clearLoadingFallback(targetWidget) {
      if (!targetWidget || !targetWidget.__aiUpsellLoadingTimer) return;
      clearTimeout(targetWidget.__aiUpsellLoadingTimer);
      targetWidget.__aiUpsellLoadingTimer = null;
    }

    let productPlaced = false;
    let productPlacementTimer = null;
    let productObserver = null;

    function placeInProductPage() {
      if (!widget) return false;
      const isProduct = window.location.pathname.includes('/products/');
      if (!isProduct) return false;

      const mainProductSection =
        document.querySelector('[id^="MainProduct-"]') ||
        document.querySelector('[id*="MainProduct"]') ||
        document.querySelector('[data-section-type*="main-product"]') ||
        document.querySelector('[data-section-id*="main-product"]') ||
        document.querySelector('main-product') ||
        document.querySelector('product-info');

      if (mainProductSection) {
        const wrapper = getWidgetWrapper(widget);
        insertAfter(mainProductSection, wrapper);
        return true;
      }

      const productForm = document.querySelector('form[action*="/cart/add"]')
        || document.querySelector('product-form')
        || document.querySelector('.product__info-container')
        || document.querySelector('.product__info-wrapper');

      const sectionFromForm = productForm ? productForm.closest('section, .shopify-section') : null;
      if (sectionFromForm) {
        const wrapper = getWidgetWrapper(widget);
        insertAfter(sectionFromForm, wrapper);
        return true;
      }

      const knownAnchors = [
        '.product__info-wrapper',
        '.product__info-container',
        '.product__media-wrapper',
        '.product__media',
        'product-info',
        'product-form'
      ];
      for (const sel of knownAnchors) {
        const el = document.querySelector(sel);
        if (el) {
          const section = el.closest('section, .shopify-section') || el;
          const wrapper = getWidgetWrapper(widget);
          insertAfter(section, wrapper);
          return true;
        }
      }

      const mainEl = document.querySelector('main');
      if (mainEl) {
        const sectionWithForm = Array.from(mainEl.querySelectorAll('section, .shopify-section'))
          .find(el => el.querySelector('form[action*="/cart/add"], product-form'));
        if (sectionWithForm) {
          const wrapper = getWidgetWrapper(widget);
          insertAfter(sectionWithForm, wrapper);
          return true;
        }
      }

      if (productForm && productForm.parentNode) {
        const wrapper = getWidgetWrapper(widget);
        insertAfter(productForm, wrapper);
        return true;
      }

      return false;
    }

    function isPlacedInMainContent(node) {
      if (!node) return false;
      const inMain = node.closest('#MainContent, main, .content-for-layout');
      const inFooter = node.closest('footer, .footer, .site-footer');
      return Boolean(inMain) && !inFooter;
    }

    function ensureProductPlacement() {
      pickWidgets();
      const isProduct = window.location.pathname.includes('/products/');
      if (!isProduct || !widget) return false;

      if (productPlaced && isPlacedInMainContent(widget)) return true;

      const placed = placeInProductPage();
      if (placed) {
        productPlaced = true;
        return true;
      }

      return isPlacedInMainContent(widget);
    }

    function startProductPlacement() {
      if (productPlacementTimer) return;
      let tries = 0;
      productPlacementTimer = setInterval(() => {
        tries += 1;
        if (ensureProductPlacement() || tries > 20) {
          clearInterval(productPlacementTimer);
          productPlacementTimer = null;
          if (productObserver) {
            productObserver.disconnect();
            productObserver = null;
          }
        }
      }, 300);

      if (!productObserver && document.body) {
        productObserver = new MutationObserver(() => {
          if (ensureProductPlacement()) {
            productObserver.disconnect();
            productObserver = null;
          }
        });
        productObserver.observe(document.body, { childList: true, subtree: true });
      }
    }

    function placeInCartPage() {
      const targetWidget = secondaryWidget || widget;
      if (!targetWidget) return;

      const mainCartItems = document.getElementById('main-cart-items');
      if (mainCartItems && mainCartItems.parentNode) {
        insertAfter(mainCartItems, targetWidget);
        return;
      }

      const cartRoot = document.querySelector('.cart');
      const cartItems = cartRoot?.querySelector('.cart__items');
      if (cartRoot && cartItems && cartItems.parentNode === cartRoot) {
        insertAfter(cartItems, targetWidget);
        return;
      }

      const cartCtas = document.querySelector('.cart__ctas');
      if (cartCtas && cartCtas.parentNode) {
        cartCtas.parentNode.insertBefore(targetWidget, cartCtas);
        return;
      }

      const checkoutButton = document.querySelector('button[name="checkout"], #checkout, .cart__checkout-button button');
      if (checkoutButton) {
        const ctaWrapper = checkoutButton.closest('.cart__ctas, .cart__checkout-button') || checkoutButton.parentElement;
        if (ctaWrapper && ctaWrapper.parentNode) {
          ctaWrapper.parentNode.insertBefore(targetWidget, ctaWrapper);
          return;
        }
        if (checkoutButton.parentNode) {
          checkoutButton.parentNode.insertBefore(targetWidget, checkoutButton);
          return;
        }
      }

      const cartFooter = document.querySelector('#main-cart-footer, .cart__footer, cart-footer');
      if (cartFooter && cartFooter.parentNode) {
        cartFooter.parentNode.insertBefore(targetWidget, cartFooter);
      }
    }

    function handleCartUpdated(event) {
      const isCart = window.location.pathname === '/cart' || window.location.pathname.startsWith('/cart');
      if (!isCart) return;
      if (event?.detail?.source === 'ai-upsell') return;
      const cartFromEvent = event?.detail?.cart;
      setTimeout(() => {
        placeInCartPage();
        refreshSecondaryFromCart(cartFromEvent);
      }, 150);
    }

      let PRODUCT_ID = '{{ product.id }}';
      const MAX_PRODUCTS = {{ upsell_settings.max_products | default: 4 }};
    const SHOPIFY_ROOT = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) ? window.Shopify.routes.root : '/';

      let secondarySourceProductId = null;
      let secondaryAllProducts = [];

      function resolveProductId() {
        if (PRODUCT_ID && PRODUCT_ID !== '') return PRODUCT_ID;
        const fromAnalytics = window.ShopifyAnalytics?.meta?.product?.id;
        const fromMeta = window.meta?.product?.id;
        const fromForm = document.querySelector('product-form')?.dataset?.productId;
        const fromData = document.querySelector('[data-product-id]')?.dataset?.productId;
        PRODUCT_ID = fromAnalytics || fromMeta || fromForm || fromData || '';
        return PRODUCT_ID;
      }

    function uniqueSecondaryById(list) {
      const seen = new Set();
      return (Array.isArray(list) ? list : []).filter((product) => {
        const id = product?.id ?? product?.productId;
        if (!id) return false;
        const key = String(id);
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    async function filterSecondaryAgainstCart(list, cartOverride) {
      try {
        let cart = cartOverride;
        if (!cart || !cart.items) {
          const cartResponse = await fetch('/cart.js');
          if (!cartResponse.ok) return list;
          cart = await cartResponse.json();
        }
        const cartIds = new Set((cart.items || []).map(item => String(item.product_id)));
        return list.filter(product => !cartIds.has(String(product.id)));
      } catch (err) {
        console.warn('‚ö†Ô∏è Secondary: failed to filter cart items:', err);
        return list;
      }
    }

    function renderSecondaryList() {
      if (!secondaryWidget) return;

      const loadingEl = secondaryWidget.querySelector('.ai-secondary-loading');
      const contentEl = secondaryWidget.querySelector('.ai-secondary-content');
      const products = secondaryAllProducts.slice(0, MAX_PRODUCTS);

      if (!products || products.length === 0) {
        secondaryWidget.style.display = 'none';
        return;
      }

      secondaryWidget.style.display = 'block';
      if (loadingEl) loadingEl.style.display = 'block';
      if (contentEl) contentEl.innerHTML = '';

      let html = `
        <div class="ai-upsell-header">
          <h2 class="ai-upsell-title">Upsell Products</h2>
        </div>
        <div class="ai-upsell-grid ai-upsell-grid-${MAX_PRODUCTS}">
      `;

      products.forEach(product => {
        let variantId = product.variantId || product.id;
        if (typeof variantId === 'string' && variantId.includes('/')) {
          variantId = variantId.split('/').pop();
        }

        html += `
          <div class="ai-upsell-card"
               data-product-id="${product.id}"
               data-inventory-quantity="${product.inventoryQuantity !== undefined ? product.inventoryQuantity : 999}"
               data-inventory-policy="${product.inventoryPolicy || 'continue'}">
            <a href="${product.url}" class="ai-upsell-link">
              <div class="ai-upsell-image-wrapper">
                ${product.image ? `<img src="${product.image}" alt="${product.title}" class="ai-upsell-image" loading="lazy" />` : ''}
              </div>
              <div class="ai-upsell-info">
                <h3 class="ai-upsell-product-title">${product.title}</h3>
                <p class="ai-upsell-price-block">
                  ${product.compareAtPrice && parseFloat(product.compareAtPrice) > parseFloat(product.price) ? `<span class="ai-upsell-compare-price">$${parseFloat(product.compareAtPrice).toFixed(2)}</span> ` : ''}
                  <span class="ai-upsell-price">$${parseFloat(product.price).toFixed(2)}</span>
                </p>
              </div>
            </a>
            <div class="ai-upsell-actions">
              <div class="ai-upsell-quantity">
                <span class="ai-qty-label">Quantity</span>
                <div class="ai-qty-controls">
                  <button class="ai-qty-btn ai-qty-minus" aria-label="Decrease quantity">‚àí</button>
                  <input type="number" class="ai-qty-input" value="1" min="1" max="99" readonly />
                  <button class="ai-qty-btn ai-qty-plus" aria-label="Increase quantity">+</button>
                </div>
              </div>
              <button class="ai-add-to-cart-btn"
                      data-variant-id="${variantId}"
                      data-product-id="${product.id}"
                      data-recommendation-type="${product.type}"
                      data-confidence="${product.confidence}"
                      ${!product.availableForSale ? 'disabled' : ''}>
                ${product.availableForSale ? 'Add to Cart' : 'Out of Stock'}
              </button>
            </div>
          </div>
        `;
      });

      html += '</div>';
      contentEl.innerHTML = html;
      if (loadingEl) loadingEl.style.display = 'none';

      // Secondary quantity button listeners
      contentEl.querySelectorAll('.ai-qty-minus').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const card = btn.closest('.ai-upsell-card');
          const input = btn.parentElement.querySelector('.ai-qty-input');
          const val = parseInt(input.value);
          if (val > 1) {
            input.value = val - 1;
            updateSecondaryPrice(card, val - 1);
          }
        });
      });

      contentEl.querySelectorAll('.ai-qty-plus').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const card = btn.closest('.ai-upsell-card');
          const input = btn.parentElement.querySelector('.ai-qty-input');
          const val = parseInt(input.value);

          const inventoryQty = parseInt(card.dataset.inventoryQuantity);
          const inventoryPolicy = card.dataset.inventoryPolicy;

          if (inventoryPolicy === 'deny' && val >= inventoryQty) {
            btn.style.opacity = '0.5';
            setTimeout(() => btn.style.opacity = '1', 200);
            return;
          }

          if (val < 99) {
            input.value = val + 1;
            updateSecondaryPrice(card, val + 1);
          }
        });
      });

      function updateSecondaryPrice(card, quantity) {
        const priceEl = card.querySelector('span.ai-upsell-price');
        if (!priceEl) return;

        const originalPrice = priceEl.getAttribute('data-original-price') || priceEl.textContent;
        const priceMatch = originalPrice.match(/[\d,]+\.?\d*/);
        if (!priceMatch) return;

        const numericPrice = parseFloat(priceMatch[0].replace(/,/g, ''));
        const totalPrice = numericPrice * quantity;

        const currencySymbol = originalPrice.match(/[^\d\s,\.]+/)?.[0] || '$';
        const formattedPrice = currencySymbol + totalPrice.toFixed(2);

        priceEl.textContent = formattedPrice;

        if (!priceEl.hasAttribute('data-original-price')) {
          priceEl.setAttribute('data-original-price', originalPrice);
        }

        // Also update compare price
        const compareEl = card.querySelector('span.ai-upsell-compare-price');
        if (compareEl) {
          const originalCompare = compareEl.getAttribute('data-original-price') || compareEl.textContent;
          const compareMatch = originalCompare.match(/[\d,]+\.?\d*/);
          if (compareMatch) {
            const numericCompare = parseFloat(compareMatch[0].replace(/,/g, ''));
            compareEl.textContent = currencySymbol + (numericCompare * quantity).toFixed(2);
            if (!compareEl.hasAttribute('data-original-price')) {
              compareEl.setAttribute('data-original-price', originalCompare);
            }
          }
        }
      }

      // Secondary add to cart button listeners
      contentEl.querySelectorAll('.ai-add-to-cart-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();

          const variantId = button.getAttribute('data-variant-id');
          const upsellProductId = button.getAttribute('data-product-id');
          const recommendationType = button.getAttribute('data-recommendation-type');
          const confidence = button.getAttribute('data-confidence');
          const originalText = button.textContent;

          const productCard = button.closest('.ai-upsell-card');
          const qtyInput = productCard.querySelector('.ai-qty-input');
          const quantity = qtyInput ? parseInt(qtyInput.value) : 1;
          const productTitleEl = productCard.querySelector('.ai-upsell-product-title');
          const productTitle = productTitleEl ? productTitleEl.textContent : 'Unknown Product';

          try {
            button.disabled = true;
            button.textContent = 'Adding...';

            window.__AI_UPSELL_SKIP_NEXT_CART_ADD__ = true;
            const response = await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: variantId, quantity: quantity })
            });

            if (!response.ok) throw new Error('Failed to add to cart');

            // Track analytics
            fetch('/apps/ai-upsell/analytics/track', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                eventType: 'cart_add',
                shopId: '{{ shop.permanent_domain }}',
                sourceProductId: secondarySourceProductId ? secondarySourceProductId.toString() : null,
                sourceProductName: 'Secondary Recommendation',
                upsellProductId: upsellProductId,
                upsellProductName: productTitle,
                variantId: variantId,
                recommendationType: recommendationType,
                confidence: parseFloat(confidence),
                quantity: quantity,
                metadata: {
                  location: 'cart_page_secondary',
                  upsellProductTitle: productTitle
                }
              })
            }).catch(err => console.error('Analytics tracking failed:', err));

            // Update cart UI
            fetch(`${SHOPIFY_ROOT}cart.js`)
              .then(res => res.json())
              .then(cart => {
                document.documentElement.dispatchEvent(
                  new CustomEvent('cart:updated', { bubbles: true, detail: { cart: cart, source: 'ai-upsell' } })
                );
                updateCartCountBubble(cart.item_count);

                fetch(`${SHOPIFY_ROOT}?sections=cart-drawer,cart-icon-bubble,main-cart-items`)
                  .then(res => res.json())
                  .then(sections => {
                    if (sections['cart-drawer']) {
                      const el = document.querySelector('cart-drawer');
                      if (el) {
                        const frag = document.createElement('div');
                        frag.innerHTML = sections['cart-drawer'];
                        const newEl = frag.querySelector('cart-drawer');
                        if (newEl) el.replaceWith(newEl);
                      }
                    }
                    if (sections['cart-icon-bubble']) {
                      const el = document.getElementById('cart-icon-bubble');
                      if (el) {
                        const frag = document.createElement('div');
                        frag.innerHTML = sections['cart-icon-bubble'];
                        const newEl = frag.querySelector('#cart-icon-bubble');
                        if (newEl) {
                          el.replaceWith(newEl);
                          updateCartCountBubble(cart.item_count);
                        }
                      }
                    }
                    if (sections['main-cart-items']) {
                      const el = document.querySelector('cart-items');
                      if (el) {
                        const frag = document.createElement('div');
                        frag.innerHTML = sections['main-cart-items'];
                        const newEl = frag.querySelector('cart-items');
                        if (newEl) el.replaceWith(newEl);
                      }
                    }
                    setTimeout(() => {
                      placeInCartPage();
                      refreshSecondaryFromCart(cart);
                    }, 200);
                  });
              });

            // Store and dispatch for further chaining
            try {
              sessionStorage.setItem('lastAiUpsellProduct', upsellProductId);
            } catch (err) {}

              document.dispatchEvent(new CustomEvent('ai-upsell:product-added', {
                detail: { productId: upsellProductId, source: 'ai-upsell' }
              }));

              // Remove the just-added product immediately from current list
              secondaryAllProducts = secondaryAllProducts.filter(
                p => String(p.id) !== String(upsellProductId)
              );
              renderSecondaryList();

              button.textContent = 'Added!';
              button.style.background = '#008060';

              setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
              button.style.background = '';
            }, 2000);

          } catch (error) {
            console.error('Secondary add to cart error:', error);
            button.textContent = 'Failed';
            button.style.background = '#d72c0d';

            setTimeout(() => {
              button.textContent = originalText;
              button.disabled = false;
              button.style.background = '';
            }, 2000);
          }
        });
      });
    }

    function updateCartCountBubble(count) {
      try {
        const targets = document.querySelectorAll('#cart-icon-bubble');
        targets.forEach((target) => {
          if (!target) return;

          let bubble = target.querySelector('.cart-count-bubble');
          if (!bubble) {
            bubble = document.createElement('div');
            bubble.className = 'cart-count-bubble';

            const vis = document.createElement('span');
            vis.setAttribute('aria-hidden', 'true');
            const hidden = document.createElement('span');
            hidden.className = 'visually-hidden';

            bubble.appendChild(vis);
            bubble.appendChild(hidden);
            target.appendChild(bubble);
          }

          const visEl = bubble.querySelector('[aria-hidden]') || bubble.querySelector('.cart-count-bubble__count');
          let hiddenEl = bubble.querySelector('.visually-hidden');
          if (!hiddenEl) {
            hiddenEl = document.createElement('span');
            hiddenEl.className = 'visually-hidden';
            bubble.appendChild(hiddenEl);
          }

          if (visEl) visEl.textContent = String(count);
          hiddenEl.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;

          bubble.hidden = count <= 0;
        });
      } catch (err) {
        console.warn('Cart bubble update failed:', err);
      }
    }

    async function fetchAiRecommendations(productId, maxProducts) {
      const apiUrl = `/apps/ai-upsell?id=gid://shopify/Product/${productId}`;
      const response = await fetch(apiUrl);
      if (!response.ok) {
        let bodyText = '';
        try { bodyText = await response.text(); } catch (_) {}
        console.warn('‚ö†Ô∏è AI recommendations request failed:', response.status, bodyText);
        return null;
      }

      const data = await response.json();
      if (!data.success || !data.recommendations || data.recommendations.length === 0) {
        return null;
      }

      return data.recommendations.slice(0, maxProducts);
    }

    async function fetchShopifyRecommendations(productId, maxProducts) {
      const url = `/recommendations/products.json?product_id=${productId}&limit=${maxProducts}`;
      const response = await fetch(url);
      if (!response.ok) {
        let bodyText = '';
        try { bodyText = await response.text(); } catch (_) {}
        console.warn('‚ö†Ô∏è Shopify recommendations request failed:', response.status, bodyText);
        return null;
      }

      const data = await response.json();
      const products = data?.products || [];
      if (products.length === 0) return null;

      return products.map((p) => {
        const variants = Array.isArray(p.variants) ? p.variants : [];
        const firstVariant = variants.find(v => v.available) || variants[0] || {};
        const priceCents = typeof p.price === 'number' ? p.price : parseInt(p.price, 10);
        const price = Number.isFinite(priceCents) ? (priceCents / 100).toFixed(2) : '0.00';
        const image = p.featured_image?.url || p.featured_image || (Array.isArray(p.images) ? p.images[0] : '');

        return {
          id: p.id,
          title: p.title,
          handle: p.handle,
          price,
          image,
          reason: 'Recommended for you',
          confidence: 0.5,
          type: 'similar',
          url: `/products/${p.handle}`,
          availableForSale: firstVariant.available !== undefined ? firstVariant.available : !!p.available,
          variantId: firstVariant.id || null,
          inventoryQuantity: 999,
          inventoryPolicy: 'continue'
        };
      });
    }

    async function fetchCartRecommendations(productGids, maxProducts) {
      const apiUrl = `/apps/ai-upsell/cart?ids=${encodeURIComponent(JSON.stringify(productGids))}`;
      const response = await fetch(apiUrl);
      if (!response.ok) {
        let bodyText = '';
        try { bodyText = await response.text(); } catch (_) {}
        console.warn('‚ö†Ô∏è AI cart recommendations request failed:', response.status, bodyText);
        return null;
      }

      const data = await response.json();
      if (!data.success || !data.recommendations || data.recommendations.length === 0) {
        return null;
      }

      return data.recommendations.slice(0, maxProducts);
    }

    async function loadAIUpsells(productIdOverride) {
      if (!widget) return;
      if (widget.__aiUpsellFetchInFlight) return;
      
      const loadingEl = widget.querySelector('.ai-upsell-loading');
      const contentEl = widget.querySelector('.ai-upsell-content');
      const currentProductId = productIdOverride || resolveProductId();
  
      if (!currentProductId) {
        startLoadingFallback(widget, loadingEl, 6000);
        if (loadingEl) loadingEl.style.display = 'block';
        if (contentEl) contentEl.style.display = 'none';
        return;
      }

      try {
        widget.__aiUpsellFetchInFlight = true;
        startLoadingFallback(widget, loadingEl, 6000);
        let products = await fetchAiRecommendations(currentProductId, MAX_PRODUCTS);
        if (!products) {
          products = await fetchShopifyRecommendations(currentProductId, MAX_PRODUCTS);
        }
        if (!products || products.length === 0) {
          clearLoadingFallback(widget);
          widget.__aiUpsellFetchInFlight = false;
          widget.style.display = 'none';
          return;
        }

        console.log('üì¶ Received products with inventory from backend:', products.map(p => ({
          handle: p.handle,
          inventoryQuantity: p.inventoryQuantity,
          inventoryPolicy: p.inventoryPolicy,
          availableForSale: p.availableForSale
        })));

        let html = `
          <div class="ai-upsell-header">
            <h2 class="ai-upsell-title">{{ upsell_settings.heading }}</h2>
            {% comment %}
            {% if upsell_settings.show_ai_badge %}
            <span class="ai-badge">ü§ñ AI Powered</span>
            {% endif %}
            {% endcomment %}
          </div>
          <div class="ai-upsell-grid ai-upsell-grid-${MAX_PRODUCTS}">
        `;

        products.forEach(product => {
          const badgeLabels = {
            'complementary': '{{ upsell_settings.badge_complementary }}',
            'similar': '{{ upsell_settings.badge_similar }}',
            'upgrade': '{{ upsell_settings.badge_upgrade }}',
            'bundle': '{{ upsell_settings.badge_bundle }}'
          };
          const badge = badgeLabels[product.type] || '{{ upsell_settings.badge_default }}';
          const confidence = Math.round((product.confidence || 0.8) * 100);

          let variantId = product.variantId || product.id;
          // Extract numeric ID from GID format (gid://shopify/ProductVariant/123 ‚Üí 123)
          if (typeof variantId === 'string' && variantId.includes('/')) {
            variantId = variantId.split('/').pop();
          }

          html += `
            <div class="ai-upsell-card" 
                 data-product-id="${product.id}"
                 data-inventory-quantity="${product.inventoryQuantity !== undefined ? product.inventoryQuantity : 999}"
                 data-inventory-policy="${product.inventoryPolicy || 'continue'}">
              <a href="${product.url}" class="ai-upsell-link">
                <div class="ai-upsell-image-wrapper">
                  ${product.image ? `<img src="${product.image}" alt="${product.title}" class="ai-upsell-image" loading="lazy" />` : ''}
                  {% comment %}
                  <span class="ai-upsell-badge">${badge}</span>
                  {% endcomment %}
                </div>
                <div class="ai-upsell-info">
                  <h3 class="ai-upsell-product-title">${product.title}</h3>
                  <p class="ai-upsell-price-block">
                    ${product.compareAtPrice && parseFloat(product.compareAtPrice) > parseFloat(product.price) ? `<span class="ai-upsell-compare-price">$${parseFloat(product.compareAtPrice).toFixed(2)}</span> ` : ''}
                    <span class="ai-upsell-price">$${parseFloat(product.price).toFixed(2)}</span>
                  </p>
                  {% if upsell_settings.show_confidence %}
                  {% endif %}
                </div>
              </a>
              <div class="ai-upsell-actions">
                <div class="ai-upsell-quantity">
                  <span class="ai-qty-label">Quantity</span>
                  <div class="ai-qty-controls">
                    <button class="ai-qty-btn ai-qty-minus" aria-label="Decrease quantity">‚àí</button>
                    <input type="number" class="ai-qty-input" value="1" min="1" max="99" readonly />
                    <button class="ai-qty-btn ai-qty-plus" aria-label="Increase quantity">+</button>
                  </div>
                </div>
                <button class="ai-add-to-cart-btn"
                        data-variant-id="${variantId}"
                        data-product-id="${product.id}"
                        data-recommendation-type="${product.type}"
                        data-confidence="${product.confidence}"
                        ${!product.availableForSale ? 'disabled' : ''}>
                  ${product.availableForSale ? 'Add to Cart' : 'Out of Stock'}
                </button>
              </div>
            </div>
          `;
        });

        html += '</div>';

        clearLoadingFallback(widget);
        widget.__aiUpsellFetched = true;
        widget.__aiUpsellFetchInFlight = false;
        loadingEl.style.display = 'none';
        contentEl.innerHTML = html;
        contentEl.style.display = 'block';

        // View events removed - only tracking cart add events

        // Add event listeners to quantity buttons
        contentEl.querySelectorAll('.ai-qty-minus').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const card = btn.closest('.ai-upsell-card');
            const input = btn.parentElement.querySelector('.ai-qty-input');
            const val = parseInt(input.value);
            if (val > 1) {
              input.value = val - 1;
              updatePrice(card, val - 1);
            }
          });
        });
        contentEl.querySelectorAll('.ai-qty-plus').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const card = btn.closest('.ai-upsell-card');
            const input = btn.parentElement.querySelector('.ai-qty-input');
            const val = parseInt(input.value);
            
            const inventoryQty = parseInt(card.dataset.inventoryQuantity);
            const inventoryPolicy = card.dataset.inventoryPolicy;
            
            if (inventoryPolicy === 'deny' && val >= inventoryQty) {
              console.log('üõë Limit reached for', card.dataset.productId, 'Qty:', inventoryQty);
              btn.style.opacity = '0.5';
              setTimeout(() => btn.style.opacity = '1', 200);
              return;
            }
            
            console.log('Inventory Check:', { val, inventoryQty, inventoryPolicy });
            
            if (val < 99) {
              input.value = val + 1;
              updatePrice(card, val + 1);
            }
          });
        });

        // Helper function to update price display based on quantity
        function updatePrice(card, quantity) {
          const priceEl = card.querySelector('span.ai-upsell-price');
          if (!priceEl) return;

          const originalPrice = priceEl.getAttribute('data-original-price') || priceEl.textContent;
          const priceMatch = originalPrice.match(/[\d,]+\.?\d*/);
          if (!priceMatch) return;

          const numericPrice = parseFloat(priceMatch[0].replace(/,/g, ''));
          const totalPrice = numericPrice * quantity;

          // Format the price with the same currency symbol
          const currencySymbol = originalPrice.match(/[^\d\s,\.]+/)?.[0] || '$';
          const formattedPrice = currencySymbol + totalPrice.toFixed(2);

          priceEl.textContent = formattedPrice;

          // Store original price on first update
          if (!priceEl.hasAttribute('data-original-price')) {
            priceEl.setAttribute('data-original-price', originalPrice);
          }

          // Also update compare price
          const compareEl = card.querySelector('span.ai-upsell-compare-price');
          if (compareEl) {
            const originalCompare = compareEl.getAttribute('data-original-price') || compareEl.textContent;
            const compareMatch = originalCompare.match(/[\d,]+\.?\d*/);
            if (compareMatch) {
              const numericCompare = parseFloat(compareMatch[0].replace(/,/g, ''));
              compareEl.textContent = currencySymbol + (numericCompare * quantity).toFixed(2);
              if (!compareEl.hasAttribute('data-original-price')) {
                compareEl.setAttribute('data-original-price', originalCompare);
              }
            }
          }
        }

        // Add event listeners to "Add to cart" buttons
        const addToCartButtons = contentEl.querySelectorAll('.ai-add-to-cart-btn');
        addToCartButtons.forEach(button => {
          button.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const variantId = button.getAttribute('data-variant-id');
            const upsellProductId = button.getAttribute('data-product-id');
            const recommendationType = button.getAttribute('data-recommendation-type');
            const confidence = button.getAttribute('data-confidence');
            const originalText = button.textContent;

            // Get the product title and quantity from the button's parent card
            const productCard = button.closest('.ai-upsell-card');
            const qtyInput = productCard.querySelector('.ai-qty-input');
            const quantity = qtyInput ? parseInt(qtyInput.value) : 1;
            const productTitleElement = productCard.querySelector('.ai-upsell-product-title');
            const productTitle = productTitleElement ? productTitleElement.textContent : 'Unknown Product';

            try {
              button.disabled = true;
              button.textContent = 'Adding...';

              window.__AI_UPSELL_SKIP_NEXT_CART_ADD__ = true;
              const response = await fetch('/cart/add.js', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  id: variantId,
                  quantity: quantity
                })
              });

              if (!response.ok) throw new Error('Failed to add to cart');

              const result = await response.json();

              // Track upsell cart addition event using App Proxy
              // Use /apps/ai-upsell/analytics/track which routes to api.proxy.analytics.track.jsx
              console.log('üìä Tracking upsell cart add (Product Page):', {
                url: '/apps/ai-upsell/analytics/track',
                product: productTitle
              });

              fetch('/apps/ai-upsell/analytics/track', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  eventType: 'cart_add',
                  shopId: '{{ shop.permanent_domain }}',
                  sourceProductId: PRODUCT_ID,
                  sourceProductName: '{{ product.title }}',
                  upsellProductId: upsellProductId,
                  upsellProductName: productTitle,
                  variantId: variantId,
                  recommendationType: recommendationType,
                  confidence: parseFloat(confidence),
                  quantity: quantity,
                  metadata: {
                    location: 'product_detail_page',
                    sourceProductTitle: '{{ product.title }}',
                    upsellProductTitle: productTitle
                  }
                })
              })
              .then(async (res) => {
                const text = await res.text();
                console.log('‚úÖ Tracking response:', res.status, text);
              })
              .catch(err => console.error('‚ùå Analytics tracking failed:', err));

              // Use Shopify's publish/subscribe system to update the cart
              // This is the recommended way to update cart in Dawn theme
              fetch(`${window.Shopify.routes.root}cart.js`)
                .then(res => res.json())
                .then(cart => {
                  // Publish cart update event (Dawn theme standard)
                  if (window.Shopify && window.Shopify.designMode) {
                    document.dispatchEvent(new CustomEvent('shopify:section:load'));
                  }

                  // Trigger theme-specific cart updates
                  document.documentElement.dispatchEvent(
                    new CustomEvent('cart:updated', {
                      bubbles: true,
                      detail: { cart: cart }
                    })
                  );

                  // Always ensure the header cart count reflects the latest cart
                  updateCartCountBubble(cart.item_count);

                  // Force reload cart drawer sections
                  fetch(`${SHOPIFY_ROOT}?sections=cart-drawer,cart-icon-bubble`)
                    .then(res => res.json())
                    .then(sections => {
                      // Update cart drawer by replacing the entire element
                      if (sections['cart-drawer']) {
                        const cartDrawerElement = document.querySelector('cart-drawer');
                        if (cartDrawerElement) {
                          const fragment = document.createElement('div');
                          fragment.innerHTML = sections['cart-drawer'];
                          const newDrawer = fragment.querySelector('cart-drawer');

                          if (newDrawer) {
                            // Replace the entire cart drawer element
                            cartDrawerElement.replaceWith(newDrawer);
                          }
                        }
                      }

                      // Update cart icon bubble
                      if (sections['cart-icon-bubble']) {
                        const cartBubble = document.getElementById('cart-icon-bubble');
                        if (cartBubble) {
                          const fragment = document.createElement('div');
                          fragment.innerHTML = sections['cart-icon-bubble'];
                          const newBubble = fragment.querySelector('#cart-icon-bubble');
                          if (newBubble) {
                            cartBubble.replaceWith(newBubble);
                            // Ensure count is visible/accurate even if theme markup differs
                            updateCartCountBubble(cart.item_count);
                          }
                        }
                      } else {
                        // Fallback when section HTML is not returned by the theme
                        updateCartCountBubble(cart.item_count);
                      }

                      // Now open the cart drawer
                      setTimeout(() => {
                        const cartIcon = document.querySelector('#cart-icon-bubble, summary[aria-controls="cart-drawer"]');
                        if (cartIcon) {
                          cartIcon.click();
                        }
                        handleCartUpdated();
                      }, 100);
                    });
                });

              // Show success feedback
              button.textContent = 'Added ‚úì';
              button.style.background = '#008060';

              // Store product ID in sessionStorage for secondary recommendations
              try {
                sessionStorage.setItem('lastAiUpsellProduct', upsellProductId);
              } catch (err) {
                console.warn('Session storage unavailable:', err);
              }

              // Dispatch event for secondary recommendations
              document.dispatchEvent(new CustomEvent('ai-upsell:product-added', {
                detail: { productId: upsellProductId, source: 'ai-upsell' }
              }));

              setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
              }, 2000);

            } catch (error) {
              console.error('Error adding to cart:', error);
              button.textContent = 'Failed';
              button.style.background = '#d72c0d';

              setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                button.style.background = '';
              }, 2000);
            }
          });
        });

      } catch (error) {
        console.error('AI Upsell Error:', error);
        clearLoadingFallback(widget);
        widget.__aiUpsellFetchInFlight = false;
        widget.style.display = 'none';
      }
    }

    async function loadCartUpsells() {
      pickWidgets();
      if (!widget) return;

      const loadingEl = widget.querySelector('.ai-upsell-loading');
      const contentEl = widget.querySelector('.ai-upsell-content');

      try {
        startLoadingFallback(widget, loadingEl, 6000);
        const cartResponse = await fetch('/cart.js');
        if (!cartResponse.ok) throw new Error('Failed to fetch cart');
        const cart = await cartResponse.json();

        if (!cart.items || cart.items.length === 0) {
          clearLoadingFallback(widget);
          widget.style.display = 'none';
          return;
        }

        const cartProductGids = cart.items.map(item => `gid://shopify/Product/${item.product_id}`);
        let products = await fetchCartRecommendations(cartProductGids, MAX_PRODUCTS);
        if (!products) {
          const fallbackProductId = cart.items[0]?.product_id;
          if (fallbackProductId) {
            products = await fetchShopifyRecommendations(fallbackProductId, MAX_PRODUCTS);
          }
        }

        if (!products || products.length === 0) {
          clearLoadingFallback(widget);
          widget.style.display = 'none';
          return;
        }

        const cartProductTitles = cart.items.map(item => item.product_title).join(', ');
        const sourceTitle = cartProductTitles || 'Cart Items';
        widget.dataset.sourceTitle = sourceTitle;

        let html = `
          <div class="ai-upsell-header">
            <h2 class="ai-upsell-title">{{ upsell_settings.heading }}</h2>
          </div>
          <div class="ai-upsell-grid ai-upsell-grid-${MAX_PRODUCTS}">
        `;

        products.forEach(product => {
          let variantId = product.variantId || product.id;
          if (typeof variantId === 'string' && variantId.includes('/')) {
            variantId = variantId.split('/').pop();
          }

          html += `
            <div class="ai-upsell-card"
                 data-product-id="${product.id}"
                 data-inventory-quantity="${product.inventoryQuantity !== undefined ? product.inventoryQuantity : 999}"
                 data-inventory-policy="${product.inventoryPolicy || 'continue'}">
              <a href="${product.url}" class="ai-upsell-link">
                <div class="ai-upsell-image-wrapper">
                  ${product.image ? `<img src="${product.image}" alt="${product.title}" class="ai-upsell-image" loading="lazy" />` : ''}
                </div>
                <div class="ai-upsell-info">
                  <h3 class="ai-upsell-product-title">${product.title}</h3>
                  <p class="ai-upsell-price-block">
                    ${product.compareAtPrice && parseFloat(product.compareAtPrice) > parseFloat(product.price) ? `<span class="ai-upsell-compare-price">$${parseFloat(product.compareAtPrice).toFixed(2)}</span> ` : ''}
                    <span class="ai-upsell-price">$${parseFloat(product.price).toFixed(2)}</span>
                  </p>
                </div>
              </a>
              <div class="ai-upsell-actions">
                <div class="ai-upsell-quantity">
                  <span class="ai-qty-label">Quantity</span>
                  <div class="ai-qty-controls">
                    <button class="ai-qty-btn ai-qty-minus" aria-label="Decrease quantity">‚àí</button>
                    <input type="number" class="ai-qty-input" value="1" min="1" max="99" readonly />
                    <button class="ai-qty-btn ai-qty-plus" aria-label="Increase quantity">+</button>
                  </div>
                </div>
                <button class="ai-add-to-cart-btn"
                        data-variant-id="${variantId}"
                        data-product-id="${product.id}"
                        data-recommendation-type="${product.type}"
                        data-confidence="${product.confidence}"
                        ${!product.availableForSale ? 'disabled' : ''}>
                  ${product.availableForSale ? 'Add to Cart' : 'Out of Stock'}
                </button>
              </div>
            </div>
          `;
        });

        html += '</div>';

        clearLoadingFallback(widget);
        loadingEl.style.display = 'none';
        contentEl.innerHTML = html;
        contentEl.style.display = 'block';

        // Quantity button listeners
        contentEl.querySelectorAll('.ai-qty-minus').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const card = btn.closest('.ai-upsell-card');
            const input = btn.parentElement.querySelector('.ai-qty-input');
            const val = parseInt(input.value);
            if (val > 1) {
              input.value = val - 1;
              updateCartPrice(card, val - 1);
            }
          });
        });
        contentEl.querySelectorAll('.ai-qty-plus').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const card = btn.closest('.ai-upsell-card');
            const input = btn.parentElement.querySelector('.ai-qty-input');
            const val = parseInt(input.value);

            const inventoryQty = parseInt(card.dataset.inventoryQuantity);
            const inventoryPolicy = card.dataset.inventoryPolicy;

            if (inventoryPolicy === 'deny' && val >= inventoryQty) {
              btn.style.opacity = '0.5';
              setTimeout(() => btn.style.opacity = '1', 200);
              return;
            }

            if (val < 99) {
              input.value = val + 1;
              updateCartPrice(card, val + 1);
            }
          });
        });

        function updateCartPrice(card, quantity) {
          const priceEl = card.querySelector('span.ai-upsell-price');
          if (!priceEl) return;

          const originalPrice = priceEl.getAttribute('data-original-price') || priceEl.textContent;
          const priceMatch = originalPrice.match(/[\d,]+\.?\d*/);
          if (!priceMatch) return;

          const numericPrice = parseFloat(priceMatch[0].replace(/,/g, ''));
          const totalPrice = numericPrice * quantity;

          const currencySymbol = originalPrice.match(/[^\d\s,\.]+/)?.[0] || '$';
          const formattedPrice = currencySymbol + totalPrice.toFixed(2);
          priceEl.textContent = formattedPrice;

          if (!priceEl.hasAttribute('data-original-price')) {
            priceEl.setAttribute('data-original-price', originalPrice);
          }

          // Also update compare price
          const compareEl = card.querySelector('span.ai-upsell-compare-price');
          if (compareEl) {
            const originalCompare = compareEl.getAttribute('data-original-price') || compareEl.textContent;
            const compareMatch = originalCompare.match(/[\d,]+\.?\d*/);
            if (compareMatch) {
              const numericCompare = parseFloat(compareMatch[0].replace(/,/g, ''));
              compareEl.textContent = currencySymbol + (numericCompare * quantity).toFixed(2);
              if (!compareEl.hasAttribute('data-original-price')) {
                compareEl.setAttribute('data-original-price', originalCompare);
              }
            }
          }
        }

        // Add to cart handlers (cart context)
        const addToCartButtons = contentEl.querySelectorAll('.ai-add-to-cart-btn');
        addToCartButtons.forEach(button => {
          button.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const variantId = button.getAttribute('data-variant-id');
            const upsellProductId = button.getAttribute('data-product-id');
            const recommendationType = button.getAttribute('data-recommendation-type');
            const confidence = button.getAttribute('data-confidence');
            const originalText = button.textContent;

            const productCard = button.closest('.ai-upsell-card');
            const qtyInput = productCard.querySelector('.ai-qty-input');
            const quantity = qtyInput ? parseInt(qtyInput.value) : 1;
            const productTitleElement = productCard.querySelector('.ai-upsell-product-title');
            const productTitle = productTitleElement ? productTitleElement.textContent : 'Unknown Product';

            try {
              button.disabled = true;
              button.textContent = 'Adding...';

              window.__AI_UPSELL_SKIP_NEXT_CART_ADD__ = true;
              const response = await fetch('/cart/add.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: variantId, quantity: quantity })
              });

              if (!response.ok) throw new Error('Failed to add to cart');

              fetch(`${SHOPIFY_ROOT}cart.js`)
                .then(res => res.json())
                .then(cart => {
                  const originalCartItems = (cart.items || []).filter(
                    item => String(item.product_id) !== String(upsellProductId)
                  );
                  const originalCartProductIds = originalCartItems.map(item => item.product_id);
                  const originalSourceTitle = originalCartItems.map(item => item.product_title).join(', ') || 'Cart Items';

                  fetch('/apps/ai-upsell/analytics/track', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      eventType: 'cart_add',
                      shopId: '{{ shop.permanent_domain }}',
                      sourceProductId: originalCartProductIds.length > 0 ? originalCartProductIds[0].toString() : null,
                      sourceProductName: originalSourceTitle,
                      upsellProductId: upsellProductId,
                      upsellProductName: productTitle,
                      variantId: variantId,
                      recommendationType: recommendationType,
                      confidence: parseFloat(confidence),
                      quantity: quantity,
                      metadata: {
                        cartProductIds: originalCartProductIds,
                        location: 'cart_page',
                        sourceProductTitle: originalSourceTitle,
                        upsellProductTitle: productTitle
                      }
                    })
                  }).catch(err => console.error('‚ùå Analytics tracking failed:', err));

                  document.documentElement.dispatchEvent(
                    new CustomEvent('cart:updated', { bubbles: true, detail: { cart: cart, source: 'ai-upsell' } })
                  );
                  updateCartCountBubble(cart.item_count);

                  fetch(`${SHOPIFY_ROOT}?sections=cart-drawer,cart-icon-bubble,main-cart-items`)
                    .then(res => res.json())
                    .then(sections => {
                      if (sections['cart-drawer']) {
                        const el = document.querySelector('cart-drawer');
                        if (el) {
                          const frag = document.createElement('div');
                          frag.innerHTML = sections['cart-drawer'];
                          const newEl = frag.querySelector('cart-drawer');
                          if (newEl) el.replaceWith(newEl);
                        }
                      }
                      if (sections['cart-icon-bubble']) {
                        const el = document.getElementById('cart-icon-bubble');
                        if (el) {
                          const frag = document.createElement('div');
                          frag.innerHTML = sections['cart-icon-bubble'];
                          const newEl = frag.querySelector('#cart-icon-bubble');
                          if (newEl) {
                            el.replaceWith(newEl);
                            updateCartCountBubble(cart.item_count);
                          }
                        }
                      }
                      if (sections['main-cart-items']) {
                        const el = document.querySelector('cart-items');
                        if (el) {
                          const frag = document.createElement('div');
                          frag.innerHTML = sections['main-cart-items'];
                          const newEl = frag.querySelector('cart-items');
                          if (newEl) el.replaceWith(newEl);
                        }
                      }

                      placeInCartPage();
                      refreshSecondaryFromCart(cart);
                    });
                });

              button.textContent = 'Added ‚úì';
              button.style.background = '#008060';

              setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                button.style.background = '';
              }, 2000);

            } catch (error) {
              console.error('Error adding to cart:', error);
              button.textContent = 'Failed';
              button.style.background = '#d72c0d';

              setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                button.style.background = '';
              }, 2000);
            }
          });
        });

      } catch (error) {
        console.error('AI Cart Upsell Error:', error);
        clearLoadingFallback(widget);
        widget.style.display = 'none';
      }
    }

    // =============================================
    // SECONDARY: Recommendations based on added upsell product
    // =============================================
    async function loadSecondaryRecommendations(productIds, cartOverride) {
      pickWidgets();
      if (!secondaryWidget || !productIds || productIds.length === 0) return;

      secondarySourceProductId = productIds[0];
      const loadingEl = secondaryWidget.querySelector('.ai-secondary-loading');
      const contentEl = secondaryWidget.querySelector('.ai-secondary-content');

      const previousProducts = secondaryAllProducts.slice();

      secondaryWidget.style.display = 'block';
      if (loadingEl) loadingEl.style.display = 'block';
      if (contentEl) contentEl.innerHTML = '';
      startLoadingFallback(secondaryWidget, loadingEl, 6000);

      try {
        const productGids = productIds.map(id => `gid://shopify/Product/${id}`);
        const apiUrl = `/apps/ai-upsell/cart?ids=${encodeURIComponent(JSON.stringify(productGids))}`;
        const response = await fetch(apiUrl);

        if (!response.ok) throw new Error('Failed to load secondary recommendations');

        const data = await response.json();

        if (!data.success || !data.recommendations || data.recommendations.length === 0) {
          clearLoadingFallback(secondaryWidget);
          secondaryWidget.style.display = 'none';
          return;
        }

        let products = uniqueSecondaryById(data.recommendations);
        products = await filterSecondaryAgainstCart(products, cartOverride);

        // Fallback: if filtered list is empty, try AI based on the first cart product
        if (!products || products.length === 0) {
          const fallbackId = productIds[0];
          const fallback = await fetchAiRecommendations(fallbackId, MAX_PRODUCTS);
          if (fallback && fallback.length > 0) {
            let fallbackProducts = uniqueSecondaryById(fallback);
            fallbackProducts = await filterSecondaryAgainstCart(fallbackProducts, cartOverride);
            products = fallbackProducts;
          }
        }

          if (!products || products.length === 0) {
            if (previousProducts && previousProducts.length > 0) {
              const cleanedPrev = await filterSecondaryAgainstCart(previousProducts, cartOverride);
              if (cleanedPrev && cleanedPrev.length > 0) {
                secondaryAllProducts = cleanedPrev;
                renderSecondaryList();
                if (loadingEl) loadingEl.style.display = 'none';
                return;
              }
            }
            clearLoadingFallback(secondaryWidget);
            secondaryWidget.style.display = 'none';
            return;
          }

        secondaryAllProducts = products;

        console.log('üîÑ Secondary recommendations loaded:', secondaryAllProducts.map(p => ({
          handle: p.handle,
          availableForSale: p.availableForSale
        })));

        clearLoadingFallback(secondaryWidget);
        renderSecondaryList();
        placeInCartPage();
      } catch (error) {
        console.error('Secondary upsell error:', error);
        clearLoadingFallback(secondaryWidget);
        secondaryWidget.style.display = 'none';
      }
    }

    async function refreshSecondaryFromCart(cartOverride) {
      pickWidgets();
      if (!secondaryWidget) return;

      try {
        let cart = cartOverride;
        if (!cart || !cart.items) {
          const cartRes = await fetch('/cart.js');
          cart = await cartRes.json();
        }
        const cartProductIds = (cart?.items || []).map(item => item.product_id);

        if (cartProductIds.length > 0) {
          console.log('üîÑ Secondary: using all cart product ids:', cartProductIds);
          loadSecondaryRecommendations(cartProductIds, cart);
        } else {
          console.log('‚ÑπÔ∏è Cart empty; no secondary recommendations.');
          secondaryWidget.style.display = 'none';
        }
      } catch (err) {
        console.warn('‚ö†Ô∏è Failed to load cart for secondary recommendations:', err);
      }
    }

    window.__AI_UPSELL_REFRESH_SECONDARY__ = refreshSecondaryFromCart;

    // Initialize
    function init() {
      pickWidgets();
      const isCartPage = window.location.pathname === '/cart' || window.location.pathname.startsWith('/cart');

      console.log('üîç Init - Cart page:', isCartPage, 'Widget:', !!widget, 'Secondary widget:', !!secondaryWidget);

        if (isCartPage) {
          if (widget) widget.style.display = 'none';
          placeInCartPage();
        } else if (widget) {
          widget.style.display = 'block';
          startProductPlacement();
          const pid = resolveProductId();
          if (pid) {
            loadAIUpsells(pid);
          } else if (!window.__AI_UPSELL_PID_TIMER__) {
            window.__AI_UPSELL_PID_TIMER__ = true;
            let pidTries = 0;
            const pidInterval = setInterval(() => {
              pidTries += 1;
              const nextId = resolveProductId();
              if (nextId) {
                loadAIUpsells(nextId);
                clearInterval(pidInterval);
              } else if (pidTries > 20) {
                clearInterval(pidInterval);
              }
            }, 400);
          }
        }

      // Cart page: always base secondary recommendations on cart items
      if (isCartPage) {
        refreshSecondaryFromCart();
      }
    }

    function maybeInit() {
      pickWidgets();
      if (window.__AI_UPSELL_INIT__) return;
      window.__AI_UPSELL_INIT__ = true;
      init();
    }

    function ensureProductFetch() {
      const isCartPage = window.location.pathname === '/cart' || window.location.pathname.startsWith('/cart');
      if (isCartPage) return;
      pickWidgets();
      if (!widget) return;
      if (widget.__aiUpsellFetched || widget.__aiUpsellFetchInFlight) return;
      const pid = resolveProductId();
      if (!pid) return;
      loadAIUpsells(pid);
    }

    if (!window.__AI_UPSELL_EVENT_LISTENERS__) {
      window.__AI_UPSELL_EVENT_LISTENERS__ = true;

      // Listen for upsell product added event (only load secondary on cart page)
      // Always base recommendations on current cart items (not sessionStorage)
      document.addEventListener('ai-upsell:product-added', (event) => {
        const isCart = window.location.pathname === '/cart' || window.location.pathname.startsWith('/cart');
        if (!isCart) return;
        if (event?.detail?.source === 'ai-upsell') return;
        refreshSecondaryFromCart(event?.detail?.cart);
      });

      document.addEventListener('shopify:section:load', () => {
        startProductPlacement();
        handleCartUpdated();
      });

      document.addEventListener('cart:updated', (event) => {
        if (window.__AI_CART_BUSY__) return;
        window.__AI_CART_BUSY__ = true;

        setTimeout(() => {
          handleCartUpdated(event);
          window.__AI_CART_BUSY__ = false;
        }, 200);
      });
    }

    startProductPlacement();
    setTimeout(ensureProductFetch, 800);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') ensureProductFetch();
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', maybeInit);
    } else {
      maybeInit();
    }
  })();
</script>

<style>
  .ai-upsell-widget {
    margin: {{ upsell_settings.margin_top }}px 0 {{ upsell_settings.margin_bottom }}px 0;
    padding: {{ upsell_settings.padding }}px;
    background: {{ upsell_settings.background_color }};
    border-radius: {{ upsell_settings.border_radius }}px;
  }

  .ai-upsell-loading {
    text-align: center;
    padding: 40px 20px;
    color: {{ upsell_settings.text_color }};
  }

  .ai-upsell-spinner {
    width: 40px;
    height: 40px;
    margin: 0 auto 16px;
    border: 4px solid rgba(0,0,0,0.1);
    border-top-color: {{ upsell_settings.primary_color }};
    border-radius: 50%;
    animation: ai-spin 1s linear infinite;
  }

  @keyframes ai-spin {
    to { transform: rotate(360deg); }
  }

  .ai-upsell-header {
    text-align: center;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .ai-upsell-title {
    font-size: {{ upsell_settings.heading_size }}px;
    font-weight: 700;
    color: {{ upsell_settings.heading_color }};
    margin: 0;
  }

  {% comment %}
  .ai-badge {
    background: {{ upsell_settings.primary_color }};
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
  }
  {% endcomment %}

  .ai-upsell-grid {
    display: grid;
    gap: {{ upsell_settings.grid_gap }}px;
  }

  .ai-upsell-grid-1 { grid-template-columns: 1fr; }
  .ai-upsell-grid-2 { grid-template-columns: repeat(2, 1fr); }
  .ai-upsell-grid-3 { grid-template-columns: repeat(3, 1fr); }
  .ai-upsell-grid-4 { grid-template-columns: repeat(4, 1fr); }

  @media (max-width: 990px) {
    .ai-upsell-grid-3,
    .ai-upsell-grid-4 {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 750px) {
    .ai-upsell-grid {
      grid-template-columns: 1fr;
    }
  }

  .ai-upsell-card {
    background: {{ upsell_settings.card_background }};
    border-radius: {{ upsell_settings.card_border_radius }}px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .ai-upsell-card:hover {
    transform: translateY(-{{ upsell_settings.hover_lift }}px);
    box-shadow: {{ upsell_settings.hover_shadow }};
  }

  .ai-upsell-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .ai-upsell-image-wrapper {
    position: relative;
    width: 100%;
    padding-top: 100%;
    overflow: hidden;
    background: #f5f5f5;
  }

  .ai-upsell-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .ai-upsell-card:hover .ai-upsell-image {
    transform: scale(1.05);
  }

  {% comment %}
  .ai-upsell-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    background: {{ upsell_settings.badge_background }};
    color: {{ upsell_settings.badge_text_color }};
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
    backdrop-filter: blur(10px);
  }
  {% endcomment %}

  .ai-upsell-info {
    padding: {{ upsell_settings.card_padding }}px;
  }

  .ai-upsell-product-title {
    font-size: {{ upsell_settings.product_title_size }}px;
    font-weight: 600;
    margin: 0 0 8px 0;
    line-height: 1.4;
    color: {{ upsell_settings.text_color }};
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .ai-upsell-price-block {
    margin: 0 0 12px 0;
    display: flex;
    align-items: baseline;
    gap: 6px;
    flex-wrap: wrap;
  }

  .ai-upsell-compare-price {
    font-size: {{ upsell_settings.price_size }}px;
    font-weight: 400;
    color: #999999;
    text-decoration: line-through;
  }

  .ai-upsell-price {
    font-size: {{ upsell_settings.price_size }}px;
    font-weight: 700;
    color: {{ upsell_settings.price_color }};
  }

  .ai-upsell-reason {
    font-size: {{ upsell_settings.reason_size }}px;
    color: {{ upsell_settings.reason_color }};
    line-height: 1.5;
    margin: 0 0 12px 0;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .ai-upsell-confidence {
    margin-top: 12px;
  }

  .ai-confidence-bar {
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 6px;
  }

  .ai-confidence-fill {
    height: 100%;
    background: {{ upsell_settings.primary_color }};
    transition: width 0.3s ease;
  }

  .ai-confidence-text {
    font-size: 11px;
    color: #999;
    font-weight: 500;
  }

  .ai-upsell-actions {
    padding: 0 {{ upsell_settings.card_padding }}px {{ upsell_settings.card_padding }}px;
  }

  .ai-add-to-cart-btn {
    width: 100%;
    background: {{ upsell_settings.add_to_cart_bg }};
    color: {{ upsell_settings.add_to_cart_text }};
    border: none;
    padding: 12px 20px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 8px;
  }

  .ai-add-to-cart-btn:hover:not(:disabled) {
    background: {{ upsell_settings.add_to_cart_hover_bg }};
    color: {{ upsell_settings.add_to_cart_hover_text }};
    transform: translateY(-1px);
  }

  .ai-add-to-cart-btn:disabled {
    background: {{ upsell_settings.add_to_cart_disabled_bg }};
    color: {{ upsell_settings.add_to_cart_disabled_text }};
    cursor: not-allowed;
  }

  .ai-add-to-cart-btn:active:not(:disabled) {
    transform: translateY(0);
  }

  .ai-upsell-quantity {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 6px 10px;
  }

  .ai-qty-label {
    font-size: 13px;
    color: {{ upsell_settings.text_color }};
  }

  .ai-qty-controls {
    display: flex;
    align-items: center;
  }

  .ai-qty-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: {{ upsell_settings.text_color }};
    transition: opacity 0.2s;
  }

  .ai-qty-btn:hover {
    opacity: 0.7;
  }

  .ai-qty-input {
    width: 36px;
    text-align: center;
    border: none;
    background: transparent;
    font-size: 14px;
    font-weight: 600;
    color: {{ upsell_settings.text_color }};
    -moz-appearance: textfield;
    appearance: textfield;
  }

  .ai-qty-input::-webkit-outer-spin-button,
  .ai-qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  /* =============================================
     SECONDARY: Cart page secondary recommendation styles
     ============================================= */
  .ai-secondary-widget {
    margin: 20px 0;
    padding: {{ upsell_settings.padding }}px;
    background: {{ upsell_settings.background_color }};
    border-radius: {{ upsell_settings.border_radius }}px;
  }

  body.template-cart .ai-upsell-widget,
  body.template-cart .ai-secondary-widget {
    width: 100%;
    grid-column: 1 / -1;
  }

  body.template-product .ai-upsell-wrapper {
    width: 100%;
    box-sizing: border-box;
  }

  .ai-secondary-loading {
    text-align: center;
    padding: 30px 16px;
    color: {{ upsell_settings.text_color }};
  }

  .ai-secondary-spinner {
    width: 32px;
    height: 32px;
    margin: 0 auto 12px;
    border: 3px solid rgba(0,0,0,0.1);
    border-top-color: {{ upsell_settings.primary_color }};
    border-radius: 50%;
    animation: ai-spin 1s linear infinite;
  }

  .ai-secondary-header {
    margin-bottom: 16px;
  }

  .ai-secondary-title {
    font-size: {{ upsell_settings.heading_size }}px;
    font-weight: 700;
    color: {{ upsell_settings.heading_color }};
    margin: 0;
  }

  .ai-secondary-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .ai-secondary-card {
    background: {{ upsell_settings.card_background }};
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;
    transition: box-shadow 0.2s ease;
  }

  .ai-secondary-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .ai-secondary-row {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    margin-bottom: 10px;
  }

  .ai-secondary-image-link {
    flex-shrink: 0;
  }

  .ai-secondary-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    background: #f5f5f5;
  }

  .ai-secondary-image-placeholder {
    width: 60px;
    height: 60px;
    background: #f0f0f0;
    border-radius: 6px;
  }

  .ai-secondary-details {
    flex: 1;
    min-width: 0;
  }

  .ai-secondary-title-link {
    text-decoration: none;
    color: inherit;
  }

  .ai-secondary-product-title {
    font-size: {{ upsell_settings.product_title_size }}px;
    font-weight: 600;
    margin: 0 0 4px 0;
    line-height: 1.3;
    color: {{ upsell_settings.text_color }};
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .ai-secondary-price {
    font-size: {{ upsell_settings.price_size }}px;
    font-weight: 700;
    color: {{ upsell_settings.price_color }};
    margin: 0;
  }

  .ai-secondary-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .ai-secondary-quantity {
    display: flex;
    align-items: center;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: #f5f5f5;
  }

  .ai-secondary-qty-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: {{ upsell_settings.text_color }};
    transition: opacity 0.2s;
  }

  .ai-secondary-qty-btn:hover {
    opacity: 0.7;
  }

  .ai-secondary-qty-input {
    width: 28px;
    text-align: center;
    border: none;
    background: transparent;
    font-size: 13px;
    font-weight: 600;
    color: {{ upsell_settings.text_color }};
    -moz-appearance: textfield;
    appearance: textfield;
  }

  .ai-secondary-qty-input::-webkit-outer-spin-button,
  .ai-secondary-qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .ai-secondary-add-btn {
    flex: 1;
    background: {{ upsell_settings.add_to_cart_bg }};
    color: {{ upsell_settings.add_to_cart_text }};
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .ai-secondary-add-btn:hover:not(:disabled) {
    background: {{ upsell_settings.add_to_cart_hover_bg }};
    color: {{ upsell_settings.add_to_cart_hover_text }};
  }

  .ai-secondary-add-btn:disabled {
    background: {{ upsell_settings.add_to_cart_disabled_bg }};
    color: {{ upsell_settings.add_to_cart_disabled_text }};
    cursor: not-allowed;
  }
</style>
