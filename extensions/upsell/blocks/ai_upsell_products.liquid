{% comment %}
  AI-Powered Upsell Products Block
  Shows intelligent product recommendations on product pages
{% endcomment %}

<div class="ai-upsell-widget" data-product-id="{{ product.id }}" data-shop="{{ shop.permanent_domain }}">
  <div class="ai-upsell-loading">
    <div class="ai-upsell-spinner"></div>
    <p>{{ block.settings.loading_text }}</p>
  </div>
  <div class="ai-upsell-content" style="display: none;"></div>
</div>

<script>
  (function() {
    const widget = document.querySelector('.ai-upsell-widget[data-product-id="{{ product.id }}"]');
    if (!widget) return;

    const PRODUCT_ID = '{{ product.id }}';
    const MAX_PRODUCTS = {{ block.settings.max_products }};

    // Robust root and cart-count updater for all Dawn variants
    const SHOPIFY_ROOT = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) ? window.Shopify.routes.root : '/';

    function updateCartCountBubble(count) {
      try {
        const targets = document.querySelectorAll('#cart-icon-bubble');
        targets.forEach((target) => {
          if (!target) return;

          let bubble = target.querySelector('.cart-count-bubble');
          if (!bubble) {
            bubble = document.createElement('div');
            bubble.className = 'cart-count-bubble';

            const vis = document.createElement('span');
            vis.setAttribute('aria-hidden', 'true');
            const hidden = document.createElement('span');
            hidden.className = 'visually-hidden';

            bubble.appendChild(vis);
            bubble.appendChild(hidden);
            target.appendChild(bubble);
          }

          const visEl = bubble.querySelector('[aria-hidden]') || bubble.querySelector('.cart-count-bubble__count');
          let hiddenEl = bubble.querySelector('.visually-hidden');
          if (!hiddenEl) {
            hiddenEl = document.createElement('span');
            hiddenEl.className = 'visually-hidden';
            bubble.appendChild(hiddenEl);
          }

          if (visEl) visEl.textContent = String(count);
          hiddenEl.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;

          bubble.hidden = count <= 0;
        });
      } catch (err) {
        console.warn('Cart bubble update failed:', err);
      }
    }

    async function loadAIUpsells() {
      const loadingEl = widget.querySelector('.ai-upsell-loading');
      const contentEl = widget.querySelector('.ai-upsell-content');

      try {
        // Use Shopify App Proxy URL format
        const apiUrl = `/apps/ai-upsell?id=gid://shopify/Product/${PRODUCT_ID}`;
        const response = await fetch(apiUrl);

        if (!response.ok) throw new Error('Failed to load recommendations');

        const data = await response.json();

        if (!data.success || !data.recommendations || data.recommendations.length === 0) {
          widget.style.display = 'none';
          return;
        }

        let products = data.recommendations.slice(0, MAX_PRODUCTS);

        // Fetch fresh product data from Shopify to get real-time availability
        const shopifyProducts = await Promise.all(
          products.map(async (product) => {
            try {
              // Extract numeric product ID from handle or use existing ID
              const productHandle = product.handle;

              // Fetch product data directly from Shopify product page JSON
              const productResponse = await fetch(`/products/${productHandle}.js`);
              if (!productResponse.ok) {
                console.warn(`Failed to fetch product ${productHandle}`);
                return product;
              }

              const shopifyProduct = await productResponse.json();

              // Get first available variant
              const firstVariant = shopifyProduct.variants?.[0];

              return {
                ...product,
                availableForSale: shopifyProduct.available,
                variantId: firstVariant?.id,
                price: firstVariant ? (firstVariant.price / 100).toFixed(2) : product.price,
                compareAtPrice: firstVariant?.compare_at_price ? (firstVariant.compare_at_price / 100).toFixed(2) : null
              };
            } catch (error) {
              console.error(`Error fetching Shopify data for ${product.handle}:`, error);
              return { ...product, availableForSale: true }; // Default to available if fetch fails
            }
          })
        );

        products = shopifyProducts;

        let html = `
          <div class="ai-upsell-header">
            <h2 class="ai-upsell-title">{{ block.settings.heading }}</h2>
            {% if block.settings.show_ai_badge %}
            <span class="ai-badge">ü§ñ AI Powered</span>
            {% endif %}
          </div>
          <div class="ai-upsell-grid ai-upsell-grid-${MAX_PRODUCTS}">
        `;

        products.forEach(product => {
          const badgeLabels = {
            'complementary': '{{ block.settings.badge_complementary }}',
            'similar': '{{ block.settings.badge_similar }}',
            'upgrade': '{{ block.settings.badge_upgrade }}',
            'bundle': '{{ block.settings.badge_bundle }}'
          };
          const badge = badgeLabels[product.type] || '{{ block.settings.badge_default }}';
          const confidence = Math.round((product.confidence || 0.8) * 100);

          const variantId = product.variantId || product.id;

          html += `
            <div class="ai-upsell-card" data-product-id="${product.id}">
              <a href="${product.url}" class="ai-upsell-link">
                <div class="ai-upsell-image-wrapper">
                  ${product.image ? `<img src="${product.image}" alt="${product.title}" class="ai-upsell-image" loading="lazy" />` : ''}
                  <span class="ai-upsell-badge">${badge}</span>
                </div>
                <div class="ai-upsell-info">
                  <h3 class="ai-upsell-product-title">${product.title}</h3>
                  <p class="ai-upsell-price">$${product.price}</p>
                  {% if block.settings.show_confidence %}
                  {% endif %}
                </div>
              </a>
              <div class="ai-upsell-actions">
                <button class="ai-add-to-cart-btn" data-variant-id="${variantId}" ${!product.availableForSale ? 'disabled' : ''}>
                  ${product.availableForSale ? 'Add to Cart' : 'Out of Stock'}
                </button>
              </div>
            </div>
          `;
        });

        html += '</div>';

        loadingEl.style.display = 'none';
        contentEl.innerHTML = html;
        contentEl.style.display = 'block';

        // Add event listeners to "Add to cart" buttons
        const addToCartButtons = contentEl.querySelectorAll('.ai-add-to-cart-btn');
        addToCartButtons.forEach(button => {
          button.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const variantId = button.getAttribute('data-variant-id');
            const originalText = button.textContent;

            try {
              button.disabled = true;
              button.textContent = 'Adding...';

              const response = await fetch('/cart/add.js', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  id: variantId,
                  quantity: 1
                })
              });

              if (!response.ok) throw new Error('Failed to add to cart');

              const result = await response.json();

              // Use Shopify's publish/subscribe system to update the cart
              // This is the recommended way to update cart in Dawn theme
              fetch(`${window.Shopify.routes.root}cart.js`)
                .then(res => res.json())
                .then(cart => {
                  // Publish cart update event (Dawn theme standard)
                  if (window.Shopify && window.Shopify.designMode) {
                    document.dispatchEvent(new CustomEvent('shopify:section:load'));
                  }

                  // Trigger theme-specific cart updates
                  document.documentElement.dispatchEvent(
                    new CustomEvent('cart:updated', {
                      bubbles: true,
                      detail: { cart: cart }
                    })
                  );

                  // Always ensure the header cart count reflects the latest cart
                  updateCartCountBubble(cart.item_count);

                  // Force reload cart drawer sections
                  fetch(`${SHOPIFY_ROOT}?sections=cart-drawer,cart-icon-bubble`)
                    .then(res => res.json())
                    .then(sections => {
                      // Update cart drawer by replacing the entire element
                      if (sections['cart-drawer']) {
                        const cartDrawerElement = document.querySelector('cart-drawer');
                        if (cartDrawerElement) {
                          const fragment = document.createElement('div');
                          fragment.innerHTML = sections['cart-drawer'];
                          const newDrawer = fragment.querySelector('cart-drawer');

                          if (newDrawer) {
                            // Replace the entire cart drawer element
                            cartDrawerElement.replaceWith(newDrawer);
                          }
                        }
                      }

                      // Update cart icon bubble
                      if (sections['cart-icon-bubble']) {
                        const cartBubble = document.getElementById('cart-icon-bubble');
                        if (cartBubble) {
                          const fragment = document.createElement('div');
                          fragment.innerHTML = sections['cart-icon-bubble'];
                          const newBubble = fragment.querySelector('#cart-icon-bubble');
                          if (newBubble) {
                            cartBubble.replaceWith(newBubble);
                            // Ensure count is visible/accurate even if theme markup differs
                            updateCartCountBubble(cart.item_count);
                          }
                        }
                      } else {
                        // Fallback when section HTML is not returned by the theme
                        updateCartCountBubble(cart.item_count);
                      }

                      // Now open the cart drawer
                      setTimeout(() => {
                        const cartIcon = document.querySelector('#cart-icon-bubble, summary[aria-controls="cart-drawer"]');
                        if (cartIcon) {
                          cartIcon.click();
                        }
                      }, 100);
                    });
                });

              // Show success feedback
              button.textContent = 'Added ‚úì';
              button.style.background = '#008060';

              setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
              }, 2000);

            } catch (error) {
              console.error('Error adding to cart:', error);
              button.textContent = 'Failed';
              button.style.background = '#d72c0d';

              setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                button.style.background = '';
              }, 2000);
            }
          });
        });

      } catch (error) {
        console.error('AI Upsell Error:', error);
        widget.style.display = 'none';
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAIUpsells);
    } else {
      loadAIUpsells();
    }
  })();
</script>

<style>
  .ai-upsell-widget {
    margin: {{ block.settings.margin_top }}px 0 {{ block.settings.margin_bottom }}px 0;
    padding: {{ block.settings.padding }}px;
    background: {{ block.settings.background_color }};
    border-radius: {{ block.settings.border_radius }}px;
  }

  .ai-upsell-loading {
    text-align: center;
    padding: 40px 20px;
    color: {{ block.settings.text_color }};
  }

  .ai-upsell-spinner {
    width: 40px;
    height: 40px;
    margin: 0 auto 16px;
    border: 4px solid rgba(0,0,0,0.1);
    border-top-color: {{ block.settings.primary_color }};
    border-radius: 50%;
    animation: ai-spin 1s linear infinite;
  }

  @keyframes ai-spin {
    to { transform: rotate(360deg); }
  }

  .ai-upsell-header {
    text-align: center;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .ai-upsell-title {
    font-size: {{ block.settings.heading_size }}px;
    font-weight: 700;
    color: {{ block.settings.heading_color }};
    margin: 0;
  }

  .ai-badge {
    background: {{ block.settings.primary_color }};
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
  }

  .ai-upsell-grid {
    display: grid;
    gap: {{ block.settings.grid_gap }}px;
  }

  .ai-upsell-grid-1 { grid-template-columns: 1fr; }
  .ai-upsell-grid-2 { grid-template-columns: repeat(2, 1fr); }
  .ai-upsell-grid-3 { grid-template-columns: repeat(3, 1fr); }
  .ai-upsell-grid-4 { grid-template-columns: repeat(4, 1fr); }

  @media (max-width: 990px) {
    .ai-upsell-grid-3,
    .ai-upsell-grid-4 {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 750px) {
    .ai-upsell-grid {
      grid-template-columns: 1fr;
    }
  }

  .ai-upsell-card {
    background: {{ block.settings.card_background }};
    border: 1px solid {{ block.settings.card_border_color }};
    border-radius: {{ block.settings.card_border_radius }}px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .ai-upsell-card:hover {
    transform: translateY(-{{ block.settings.hover_lift }}px);
    box-shadow: {{ block.settings.hover_shadow }};
  }

  .ai-upsell-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .ai-upsell-image-wrapper {
    position: relative;
    width: 100%;
    padding-top: 100%;
    overflow: hidden;
    background: #f5f5f5;
  }

  .ai-upsell-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .ai-upsell-card:hover .ai-upsell-image {
    transform: scale(1.05);
  }

  .ai-upsell-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    background: {{ block.settings.badge_background }};
    color: {{ block.settings.badge_text_color }};
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
    backdrop-filter: blur(10px);
  }

  .ai-upsell-info {
    padding: {{ block.settings.card_padding }}px;
  }

  .ai-upsell-product-title {
    font-size: {{ block.settings.product_title_size }}px;
    font-weight: 600;
    margin: 0 0 8px 0;
    line-height: 1.4;
    color: {{ block.settings.text_color }};
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .ai-upsell-price {
    font-size: {{ block.settings.price_size }}px;
    font-weight: 700;
    color: {{ block.settings.price_color }};
    margin: 0 0 12px 0;
  }

  .ai-upsell-reason {
    font-size: {{ block.settings.reason_size }}px;
    color: {{ block.settings.reason_color }};
    line-height: 1.5;
    margin: 0 0 12px 0;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .ai-upsell-confidence {
    margin-top: 12px;
  }

  .ai-confidence-bar {
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 6px;
  }

  .ai-confidence-fill {
    height: 100%;
    background: {{ block.settings.primary_color }};
    transition: width 0.3s ease;
  }

  .ai-confidence-text {
    font-size: 11px;
    color: #999;
    font-weight: 500;
  }

  .ai-upsell-actions {
    padding: 0 {{ block.settings.card_padding }}px {{ block.settings.card_padding }}px;
  }

  .ai-add-to-cart-btn {
    width: 100%;
    background: #008060;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 8px;
  }

  .ai-add-to-cart-btn:hover:not(:disabled) {
    background: #006e52;
    transform: translateY(-1px);
  }

  .ai-add-to-cart-btn:disabled {
    background: #e0e0e0;
    color: #999;
    cursor: not-allowed;
  }

  .ai-add-to-cart-btn:active:not(:disabled) {
    transform: translateY(0);
  }
</style>

{% schema %}
{
  "name": "AI Upsell Products",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Upsell Products"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Heading Size",
      "min": 18,
      "max": 36,
      "step": 2,
      "default": 28,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum Products",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_ai_badge",
      "label": "Show AI Badge",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_reason",
      "label": "Show Recommendation Reason",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_confidence",
      "label": "Show Confidence Score",
      "default": true
    },
    {
      "type": "header",
      "content": "Badge Labels"
    },
    {
      "type": "text",
      "id": "badge_complementary",
      "label": "Complementary Badge",
      "default": "‚ú® Perfect Match"
    },
    {
      "type": "text",
      "id": "badge_similar",
      "label": "Similar Badge",
      "default": "üîÑ Similar"
    },
    {
      "type": "text",
      "id": "badge_upgrade",
      "label": "Upgrade Badge",
      "default": "‚¨ÜÔ∏è Upgrade"
    },
    {
      "type": "text",
      "id": "badge_bundle",
      "label": "Bundle Badge",
      "default": "üì¶ Bundle"
    },
    {
      "type": "text",
      "id": "badge_default",
      "label": "Default Badge",
      "default": "‚≠ê Recommended"
    },
    {
      "type": "text",
      "id": "loading_text",
      "label": "Loading Text",
      "default": "Finding perfect products for you..."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f9f9f9"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#667eea"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price Color",
      "default": "#2c6ecb"
    },
    {
      "type": "color",
      "id": "reason_color",
      "label": "Reason Text Color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_border_color",
      "label": "Card Border Color",
      "default": "#e0e0e0"
    },
    {
      "type": "color",
      "id": "badge_background",
      "label": "Badge Background",
      "default": "rgba(0,0,0,0.8)"
    },
    {
      "type": "color",
      "id": "badge_text_color",
      "label": "Badge Text Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Spacing & Layout"
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Margin Top",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Margin Bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding",
      "label": "Container Padding",
      "min": 0,
      "max": 60,
      "step": 5,
      "default": 30,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_padding",
      "label": "Card Padding",
      "min": 8,
      "max": 32,
      "step": 2,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "grid_gap",
      "label": "Grid Gap",
      "min": 10,
      "max": 40,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Container Border Radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "label": "Card Border Radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "product_title_size",
      "label": "Product Title Size",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "price_size",
      "label": "Price Size",
      "min": 14,
      "max": 28,
      "step": 1,
      "default": 18,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "reason_size",
      "label": "Reason Text Size",
      "min": 11,
      "max": 16,
      "step": 1,
      "default": 13,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Hover Effects"
    },
    {
      "type": "range",
      "id": "hover_lift",
      "label": "Hover Lift",
      "min": 0,
      "max": 12,
      "step": 2,
      "default": 4,
      "unit": "px"
    },
    {
      "type": "text",
      "id": "hover_shadow",
      "label": "Hover Shadow",
      "default": "0 8px 20px rgba(0,0,0,0.1)"
    }
  ]
}
{% endschema %}
